name: Create Issue from Template

# このワークフローを使用すると、GitHubのActionsタブからボタンクリックでイシューを作成できます
#
# 使い方:
#   1. GitHubリポジトリのActionsタブに移動
#   2. "Create Issue from Template" ワークフローを選択
#   3. "Run workflow" ボタンをクリック
#   4. テンプレートを選択して実行

on:
  workflow_dispatch:
    inputs:
      template:
        description: 'Issue template to use'
        required: true
        default: 'authentication-implementation'
        type: choice
        options:
          - authentication-implementation

jobs:
  create-issue:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Read template file
        id: template
        run: |
          TEMPLATE_FILE=".github/ISSUE_TEMPLATE/${{ github.event.inputs.template }}.md"
          
          if [ ! -f "$TEMPLATE_FILE" ]; then
            echo "Error: Template file not found: $TEMPLATE_FILE"
            exit 1
          fi
          
          # YAMLフロントマターを削除して本文のみを取得
          BODY=$(awk 'BEGIN{p=0} /^---$/{p++; next} p==2{print}' "$TEMPLATE_FILE")
          
          # マルチライン出力用にエスケープ
          echo "body<<EOF" >> $GITHUB_OUTPUT
          echo "$BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          # タイトルとラベルをYAMLフロントマターから抽出
          TITLE=$(grep "^title:" "$TEMPLATE_FILE" | sed 's/title: //' | tr -d "'\"")
          LABELS=$(grep "^labels:" "$TEMPLATE_FILE" | sed 's/labels: //' | tr -d " ")
          
          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "labels=$LABELS" >> $GITHUB_OUTPUT
      
      - name: Create issue
        uses: actions/github-script@v7
        with:
          script: |
            const title = `${{ steps.template.outputs.title }}`;
            const body = `${{ steps.template.outputs.body }}`;
            const labels = `${{ steps.template.outputs.labels }}`.split(',').filter(l => l);
            
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: labels
            });
            
            console.log(`Created issue #${issue.data.number}: ${issue.data.html_url}`);
            
            // 作成したイシューのURLをジョブサマリーに出力
            await core.summary
              .addHeading('✅ イシューが作成されました')
              .addLink(`#${issue.data.number}: ${title}`, issue.data.html_url)
              .write();
      
      - name: Output result
        if: success()
        run: |
          echo "✅ イシューの作成に成功しました"
          echo "イシューを確認してください: https://github.com/${{ github.repository }}/issues"
